/** common-query.min.js - v0.0.21 - Mon, 22 Sep 2014 17:48:24 GMT */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;"undefined"!=typeof window?r=window:"undefined"!=typeof global?r=global:"undefined"!=typeof self&&(r=self),(r.ZS||(r.ZS={})).commonQuery=e()}}(function(){return function e(r,n,t){function o(a,f){if(!n[a]){if(!r[a]){var u="function"==typeof require&&require;if(!f&&u)return u(a,!0);if(i)return i(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var s=n[a]={exports:{}};r[a][0].call(s.exports,function(e){var n=r[a][1][e];return o(n?n:e)},s,s.exports,e,r,n,t)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<t.length;a++)o(t[a]);return o}({1:[function(e,r,n){function t(e,r){function n(e){e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).forEach(function(r){if("$and"!=r&&"$or"!=r&&"$nor"!=r||!Array.isArray(e[r])){if("$"!=r[0]&&(o[r]=!0,"object"==typeof e[r]&&e[r]&&e[r].$elemMatch)){var i=t(null,e[r].$elemMatch);Array.isArray(i)&&i.forEach(function(e){o[r+"."+e]=!0})}}else e[r].forEach(function(e){n(e)})})}var o={};return n(r),Object.keys(o)}function o(e,r,n){function t(e){if(!e||"object"!=typeof e||Array.isArray(e))return e;var r={};return Object.keys(e).forEach(function(o){"$and"!=o&&"$or"!=o&&"$nor"!=o||!Array.isArray(e[o])?"$elemmatch"==o.toLowerCase()?r[o]=e[o]:"$"==o[0]?r[o]=t(e[o]):r[n(o)]=t(e[o]):r[o]=e[o].map(function(e){return t(e)})}),r}return r=h(!0,{},r),t(r)}function i(e){if(!e||"object"!=typeof e)return{};var r={};for(var n in e)"object"!=typeof e[n]&&null!==e[n]&&void 0!==e[n]&&"$"!=n[0]&&v(r,n,e[n]);return r}function a(e){if(!e||"object"!=typeof e)return!1;for(var r in e)if("object"==typeof e[r]||null===e[r]||void 0===e[r]||"$"==r[0])return!1;return!0}function f(e,r){if(!e||"object"!=typeof e)return!1;for(var n={},t=0;t<r.length;t++)n[r[t]]=!0;if(Object.keys(n).length!=Object.keys(e).length)return!1;for(var o in e){if("object"==typeof e[o]||null===e[o]||void 0===e[o]||"$"==o[0])return!1;if(!n[o])return!1}return!0}function u(e,r){function n(e){e&&"object"==typeof e&&Object.keys(e).forEach(function(r){"$"==r[0]&&(t[r]=!0),n(e[r])})}var t={};return n(r),Object.keys(t)}function l(e){return"object"==typeof e&&!Array.isArray(e)&&e&&Object.keys(e).length&&Object.keys(e).every(function(e){return"$"==e[0]})?!0:!1}function s(e){return e&&"object"==typeof e?1!=Object.keys(e).length?!1:e.$var&&"string"==typeof e.$var?!0:!1:!1}function c(e,r,n){function t(e){if(!s(e))return"object"==typeof e?(Object.keys(e).forEach(function(r){e[r]=t(e[r])}),e):e;var i=e.$var;return void 0!==r[i]?r[i]:n?null:void o.push(i)}var o=[],i=t(e);return o.length?new b(b.INVALID_QUERY,"Missing query variables: "+o.join(", "),{missingVars:o}):i}function d(e,r){function n(e,r){if(void 0!==r)if(void 0===o[e])o[e]=r;else if(o[e]!==r)if(Array.isArray(o.$and)&&"$and"===e&&Array.isArray(r))o.$and=o.$and.concat(r);else if("$and"===e)void 0===o.$and||Array.isArray(o.$and)||(o.$and=[o.$and]),Array.isArray(r)||(r=[r]),o.$and=o.$and.concat(r);else{o.$and&&!Array.isArray(o.$and)&&(o.$and=[o.$and]),o.$and||(o.$and=[]);var n={};n[e]=r,o.$and.push(n)}}var t,o={};for(t in e)n(t,e[t]);for(t in r)n(t,r[t]);return o}function y(e,r,n,t,o){function i(e){null!==e&&("object"!=typeof e||o&&s(e)?f(e):u(null,e).length&&m.push(new b(b.INVALID_QUERY,"Plain value object may not contain operators",{value:e})))}function a(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function f(e){return o&&s(e)?!0:a(e)}function c(e){return Array.isArray(e)?void e.forEach(function(e){a(e)}):void m.push(new b(b.INVALID_QUERY,"Value must be array: "+e))}function d(e){"boolean"!=typeof e&&m.push(new b(b.INVALID_QUERY,"Value must be boolean: "+e))}function y(e){"string"!=typeof e&&m.push(new b(b.INVALID_QUERY,"Value must be string: "+e))}function p(e,r){function n(n,t){if(!I[n])return void m.push(new b(b.INVALID_QUERY,"Invalid or disallowed operator expression: "+n));if("$gt"==n||"$gte"==n||"$lt"==n||"$lte"==n||"$ne"==n)f(t);else if("$in"==n||"$nin"==n)c(t);else if("$not"==n){if(r)return void m.push(new b(b.INVALID_QUERY,"Nested $not expressions disallowed"));p(t,!0)}else"$exists"==n?d(t):"$regex"==n||"$wildcard"==n||"$text"==n?(y(t),!!e.$regex+!!e.$wildcard+!!e.$text>1&&m.push(new b(b.INVALID_QUERY,"$regex, $wildcard, and $text cannot be used together in the same operator expression"))):"$elemMatch"==n?w(t):"$options"==n?(y(t),e.$regex||e.$wildcard||m.push(new b(b.INVALID_QUERY,"$options operator is only valid with $regex or $wildcard"))):m.push(new b(b.INVALID_QUERY,"Unknown or invalid expression operator: "+n))}return e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?void Object.keys(e).forEach(function(r){n(r,e[r])}):void m.push(new b(b.INVALID_QUERY,"Operator expression must be object"))}function $(e){l(e)?p(e):i(e)}function w(e){return e&&"object"==typeof e?void Object.keys(e).forEach(function(r){var n=e[r];if(!r)return void m.push(new b(b.INVALID_QUERY,"Field name may not be blank",{query:e}));if("$"==r[0]){if(!I[r])return void m.push(new b(b.INVALID_QUERY,"Invalid or disallowed operator: "+r));if("$and"==r||"$or"==r||"$nor"==r){if(!Array.isArray(n)||!n.length)return void m.push(new b(b.INVALID_QUERY,"Value of $and or $or must be an array with at least one element",{query:e}));n.forEach(function(e){w(e)})}else{if("$child"!=r&&"$parent"!=r)return void m.push(new b(b.INVALID_QUERY,"Operator "+r+" cannot be used as a query-level operator",{query:e}));if("object"!=typeof n||!n)return void m.push(new b(b.INVALID_QUERY,"Invalid $child/$parent operator value",{query:e}));Object.keys(n).forEach(function(e){w(n[e])})}}else $(n)}):void m.push(new b(b.INVALID_QUERY,"Query must be object",{query:e}))}n||(n=["$and","$or","$nor","$exists","$in","$not","$text","$wildcard","$regex","$gt","$gte","$lt","$lte","$ne","$elemMatch","$options"]),t&&(n=n.concat(t));var I={};n.forEach(function(e){I[e]=!0});var m=[];return w(r),m.length?m[0]:!0}function p(e){for(var r,n="^",t=0;t<e.length;t++)r=e[t],n+="*"==r?".*":"?"==r?".?":w(r);return n+"$"}function $(e,r,n,t){function o(e,r,n,o,i){return"$in"==n?Array.isArray(o)?o.some(function(e){return A(e,r)}):(s.push(new b(b.INTERNAL_ERROR,"Invalid query after validation - expected array for $in")),!1):"$text"==n?(t.textMatches||E)(r,o):"$wildcard"==n?new RegExp(p(o),i.$options).test(r):"$regex"==n?new RegExp(o,i.$options).test(r):"$gt"==n?r>o:"$gte"==n?r>=o:"$lt"==n?o>r:"$lte"==n?o>=r:"$ne"==n?!A(r,o):"$options"==n?!0:(s.push(new b(b.INTERNAL_ERROR,"Unknown operator expr operator after validation: "+n)),!1)}function i(e,r,n,t,a){return"$exists"==n?t?void 0!==r:void 0===r:"$not"==n?!Object.keys(t).every(function(n){return i(e,r,n,t[n],t)}):"$elemMatch"==n?Array.isArray(r)?r.some(function(e){var r=$(null,t,e,!0);return r instanceof b?(s.push(r),!1):r}):!1:Array.isArray(r)?r.some(function(r){return o(e,r,n,t,a)}):o(e,r,n,t,a)}function a(e,r){var t=m(n,e);return l(r)?Object.keys(r).every(function(n){return i(e,t,n,r[n],r)}):void 0===t?!1:Array.isArray(t)?t.some(function(e){return A(e,r)}):A(t,r)}function f(e){return Object.keys(e).every(function(r){var n=e[r];return"$"==r[0]?"$and"==r?n.every(f):"$or"==r?n.some(f):"$nor"==r?!n.some(f):(s.push(new b(b.INTERNAL_ERROR,"Query processing failed after validation - got unknown query level operator: "+r)),!1):a(r,n)})}if(t||(t={}),!t.skipValidate){var u=y(e,r);if(u!==!0)return u}var s=[],c=f(r);return s.length?s[0]:!!c}var b="undefined"!=typeof window?window.ZS.Error:"undefined"!=typeof global?global.ZS.Error:null,w=e("regexp-quote"),I="undefined"!=typeof window?window.ZS.objtools:"undefined"!=typeof global?global.ZS.objtools:null,m=I.getPath,v=I.setPath,A=I.deepEquals,h="undefined"!=typeof window?window.extend:"undefined"!=typeof global?global.extend:null,E=function(e,r){return new RegExp(r.replace(" ",".+")).test(e)};n.getQueriedFields=t,n.transformQueriedFields=o,n.queryToObject=i,n.isBasicQuery=a,n.queryMatchesExactFieldSet=f,n.getOperators=u,n.isOperatorExpr=l,n.substituteVars=c,n.combineQueriesAnd=d,n.validateQuery=y,n.makeWildcardRegex=p,n.queryMatches=$},{extend:"extend",objtools:"objtools","regexp-quote":3,"zs-error":"zs-error"}],2:[function(e,r,n){function t(e,r,n,t){function o(e){return l[e]?!0:"function"==typeof t.internalFields&&t.internalFields(e)?!0:!1}function i(e,r,n){var t,a,f,l;for(t in r)r.hasOwnProperty(t)&&(f=e[t],l=r[t],a=n?n+"."+t:t,"object"!=typeof f||!f||Array.isArray(f)||"object"!=typeof l||!l||Array.isArray(l)?u.scalarEquals(l,f)||(s[a]=!0):i(f,l,a));for(t in e)e.hasOwnProperty(t)&&(a=n?n+"."+t:t,void 0!==r[t]||o(a)||(s[a]=!0))}if(t||(t={}),!n||"object"!=typeof n)return[];var f,l={};if(Array.isArray(t.internalFields))for(f=0;f<t.internalFields.length;f++)l[t.internalFields[f]]=!0;else"object"==typeof t.internalFields&&t.internalFields&&(l=t.internalFields);var s={};if(!a(n)){if(t.allowFullReplace)return i(r,n,""),Object.keys(s);n={$set:n}}for(var c in n)if(n.hasOwnProperty(c)){var d=n[c];if(d&&"object"==typeof d)for(var y in d)d.hasOwnProperty(y)&&(s[y]=!0)}return Object.keys(s)}function o(e,r,n){if(!r||"object"!=typeof r)return r;if(a(r)){r=y(!0,{},r);for(var t in r)if(r.hasOwnProperty(t)){var o=r[t];if(o&&"object"==typeof o)for(var i in o)o.hasOwnProperty(i)&&(o[n(i)]=o[i])}return r}var f={};for(var u in r)r.hasOwnProperty(u)&&(f[n(u)]=r[u]);return f}function i(e,r,n,t){if(!r||"object"!=typeof r)return new d(d.INVALID_QUERY,"Update must be object");if(!a(r))return!0;n||(n=["$inc","$mul","$rename","$set","$unset","$min","$max","$currentDate","$addToSet","$pop","$push"]),t&&(n=n.concat(t));var o={};n.forEach(function(e){o[e]=!0});for(var i in r)if(r.hasOwnProperty(i)&&!o[i])return new d(d.INVALID_QUERY,"Update contains invalid, disallowed, or unknown operator: "+i);return!0}function a(e){var r=!1;for(var n in e)e.hasOwnProperty(n)&&"$"==n[0]&&(r=!0);return r}function f(e,r,n,t){function o(e){return v[e]?!0:"function"==typeof t.internalFields&&t.internalFields(e)?!0:!1}function i(e,n){o(e)||(s(r,e,n),t.modifiedCallback&&t.modifiedCallback.call(r,e,n))}function f(e){return l(r,e)}function y(e){o(e)||(c(r,e),t.modifiedCallback&&t.modifiedCallback.call(r,e,void 0))}function p(e,n,i){var a,f,l,s;for(a in n)n.hasOwnProperty(a)&&(l=e[a],s=n[a],f=i?i+"."+a:a,o(f)||("object"!=typeof l||!l||Array.isArray(l)||"object"!=typeof s||!s||Array.isArray(s)?u.scalarEquals(s,l)||(e[a]=s,t.modifiedCallback&&t.modifiedCallback.call(r,f,s)):p(l,s,f)));for(a in e)e.hasOwnProperty(a)&&(f=i?i+"."+a:a,o(f)||void 0===n[a]&&(delete e[a],t.modifiedCallback&&t.modifiedCallback.call(r,f,void 0)))}var $,b,w,I,m;if(t||(t={}),!n||"object"!=typeof n)return new d(d.INVALID_QUERY,"Update must be object");if(!r||"object"!=typeof r)return new d(d.INTERNAL_ERROR,"Document must be object");var v={};if(Array.isArray(t.internalFields))for(I=0;I<t.internalFields.length;I++)v[t.internalFields[I]]=!0;else"object"==typeof t.internalFields&&t.internalFields&&(v=t.internalFields);if(!a(n)){if(t.allowFullReplace)return p(r,n,""),r;n={$set:n}}for(var A in n)if(n.hasOwnProperty(A)){if("$"!=A[0])return new d(d.INVALID_QUERY,"Update cannot contain mix of operators and non-operators");var h=n[A];switch(A){case"$inc":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $inc must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],"number"!=typeof w)return new d(d.INVALID_QUERY,"$inc values must be numbers");if(null===b||void 0===b)b=h[$];else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$inc can only operate on numeric fields (field "+$+") is of type "+typeof b);b+=w}i($,b)}break;case"$mul":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $mul must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],"number"!=typeof w)return new d(d.INVALID_QUERY,"$mul values must be numbers");if(null===b||void 0===b)b=0;else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$mul can only operate on numeric fields (field "+$+") is of type "+typeof b);b*=w}i($,b)}break;case"$rename":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $rename must be object");var E={};for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],"string"!=typeof w||"$"==w[0])return new d(d.INVALID_QUERY,"$rename values must be valid field names");E[$]=b,y($)}for($ in h)h.hasOwnProperty($)&&i(h[$],E[$]);break;case"$set":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $set must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);w=h[$],i($,w)}break;case"$unset":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $unset must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);y($)}break;case"$min":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $min must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],"number"!=typeof w)return new d(d.INVALID_QUERY,"$min values must be numbers");if(null===b||void 0===b)i($,w);else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$min can only operate on numeric fields (field "+$+") is of type "+typeof b);b>w&&i($,w)}}break;case"$max":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $max must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],"number"!=typeof w)return new d(d.INVALID_QUERY,"$max values must be numbers");if(null===b||void 0===b)i($,w);else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$max can only operate on numeric fields (field "+$+") is of type "+typeof b);w>b&&i($,w)}}break;case"$currentDate":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $currentDate must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(w=h[$],w!==!0&&(!w||"object"!=typeof w||1!=Object.keys(w).length||"timestamp"!==w.$type&&"date"!==w.$type))return new d(d.INVALID_QUERY,"Invalid $currentDate parameter value");i($,new Date)}break;case"$addToSet":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $addToSet must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],w&&"object"==typeof w&&w.$each){if(m=w.$each,!Array.isArray(m))return new d(d.INVALID_QUERY,"Parameter to $each must be array");if((null===b||void 0===b)&&(b=[],i($,b)),!Array.isArray(b))return new d(d.INVALID_QUERY,"$addToSet can only operate on array fields");for(I=0;I<m.length;I++){if(!u.isScalar(m[I]))return new d(d.INVALID_QUERY,"$addToSet values must be scalar");-1==b.indexOf(m[I])&&b.push(m[I])}}else{if(!u.isScalar(w))return new d(d.INVALID_QUERY,"$addToSet values must be scalar");if(null===b||void 0===b)i($,[w]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"$addToSet can only operate on array fields");-1==b.indexOf(w)&&b.push(w)}}}break;case"$pop":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $pop must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],-1!==w&&1!==w)return new d(d.INVALID_QUERY,"Parameter to $pop must be 1 or -1");if(null===b||void 0===b)i($,[]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"Field for $pop must be array");1===w?b.pop():b.shift()}}break;case"$push":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $push must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),w=h[$],w&&"object"==typeof w&&w.$each){if(m=w.$each,!Array.isArray(m))return new d(d.INVALID_QUERY,"Parameter to $each must be array");if((null===b||void 0===b)&&(b=[],i($,b)),!Array.isArray(b))return new d(d.INVALID_QUERY,"$push can only operate on array fields");for(I=0;I<m.length;I++)b.push(m[I])}else if(null===b||void 0===b)i($,[w]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"$push can only operate on array fields");b.push(w)}}break;default:return new d(d.INVALID_QUERY,"Update contains invalid/unknown operator "+A)}}return r}var u="undefined"!=typeof window?window.ZS.objtools:"undefined"!=typeof global?global.ZS.objtools:null,l=u.getPath,s=u.setPath,c=u.deletePath,d="undefined"!=typeof window?window.ZS.Error:"undefined"!=typeof global?global.ZS.Error:null,y="undefined"!=typeof window?window.extend:"undefined"!=typeof global?global.extend:null;n.getUpdatedFields=t,n.transformUpdatedFields=o,n.validateUpdate=i,n.updateHasOperators=a,n.applyUpdate=f},{extend:"extend",objtools:"objtools","zs-error":"zs-error"}],3:[function(e,r){r.exports=function(e){return e.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")}},{}],"common-query":[function(e,r,n){var t,o=e("./query"),i=e("./update");for(t in o)n[t]=o[t];for(t in i)n[t]=i[t]},{"./query":1,"./update":2}]},{},[])("common-query")});