/** common-query.min.js - v0.0.23 - Tue, 11 Nov 2014 20:55:32 GMT */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;"undefined"!=typeof window?r=window:"undefined"!=typeof global?r=global:"undefined"!=typeof self&&(r=self),(r.ZSModule||(r.ZSModule={})).commonQuery=e()}}(function(){return function e(r,t,n){function o(a,u){if(!t[a]){if(!r[a]){var f="function"==typeof require&&require;if(!u&&f)return f(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var l=t[a]={exports:{}};r[a][0].call(l.exports,function(e){var t=r[a][1][e];return o(t?t:e)},l,l.exports,e,r,t,n)}return t[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(e,r){function t(e){this.query=e}function n(e){function r(e){e&&"object"==typeof e&&Object.keys(e).forEach(function(n){"$"==n[0]&&(t[n]=!0),r(e[n])})}var t={};return r(e),Object.keys(t)}function o(e){return"object"==typeof e&&!Array.isArray(e)&&e&&Object.keys(e).length&&Object.keys(e).every(function(e){return"$"==e[0]})?!0:!1}function i(e){return e&&"object"==typeof e?1!=Object.keys(e).length?!1:e.$var&&"string"==typeof e.$var?!0:!1:!1}function a(e){for(var r,t="^",n=0;n<e.length;n++)r=e[n],t+="*"==r?".*":"?"==r?".?":s(r);return t+"$"}function u(e,r,t){function n(e,r,n,o,i){return"$in"==n?Array.isArray(o)?o.some(function(e){return p(e,r)}):(c.push(new f(f.INTERNAL_ERROR,"Invalid query after validation - expected array for $in")),!1):"$text"==n?(t.textMatches||$)(r,o):"$wildcard"==n?new RegExp(a(o),i.$options).test(r):"$regex"==n?new RegExp(o,i.$options).test(r):"$gt"==n?r>o:"$gte"==n?r>=o:"$lt"==n?o>r:"$lte"==n?o>=r:"$ne"==n?!p(r,o):"$options"==n?!0:(c.push(new f(f.INTERNAL_ERROR,"Unknown operator expr operator after validation: "+n)),!1)}function i(e,r,t,o,a){return"$exists"==t?o?void 0!==r:void 0===r:"$not"==t?!Object.keys(o).every(function(t){return i(e,r,t,o[t],o)}):"$elemMatch"==t?Array.isArray(r)?r.some(function(e){var r=u(o,e,{skipValidate:!0});return r instanceof f?(c.push(r),!1):r}):!1:Array.isArray(r)?r.some(function(r){return n(e,r,t,o,a)}):n(e,r,t,o,a)}function s(e,t){var n=d(r,e);return o(t)?Object.keys(t).every(function(r){return i(e,n,r,t[r],t)}):void 0===n?!1:Array.isArray(n)?n.some(function(e){return p(e,t)}):p(n,t)}function l(e){return Object.keys(e).every(function(r){var t=e[r];return"$"==r[0]?"$and"==r?t.every(l):"$or"==r?t.some(l):"$nor"==r?!t.some(l):(c.push(new f(f.INTERNAL_ERROR,"Query processing failed after validation - got unknown query level operator: "+r)),!1):s(r,t)})}t||(t={}),t.skipValidate||this.validate();var c=[],y=l(e);if(c.length)throw c[0];return!!y}var f="undefined"!=typeof window?window.ZSModule.ZSError:"undefined"!=typeof global?global.ZSModule.ZSError:null,s=e("regexp-quote"),l="undefined"!=typeof window?window.ZSModule.objtools:"undefined"!=typeof global?global.ZSModule.objtools:null,d=l.getPath,c=l.setPath,p=l.deepEquals,y="undefined"!=typeof window?window.extend:"undefined"!=typeof global?global.extend:null,$=function(e,r){return new RegExp(r.replace(" ",".+")).test(e)};r.exports=t,t.prototype.getFields=function(){function e(r){function t(r){r&&"object"==typeof r&&!Array.isArray(r)&&Object.keys(r).forEach(function(o){if("$and"!=o&&"$or"!=o&&"$nor"!=o||!Array.isArray(r[o])){if("$"!=o[0]&&(n[o]=!0,"object"==typeof r[o]&&r[o]&&r[o].$elemMatch)){var i=e(r[o].$elemMatch);Array.isArray(i)&&i.forEach(function(e){n[o+"."+e]=!0})}}else r[o].forEach(function(e){t(e)})})}var n={};return t(r),Object.keys(n)}return e(this.query)},t.prototype.transformFields=function(e){function r(t){if(!t||"object"!=typeof t||Array.isArray(t))return t;var n={};return Object.keys(t).forEach(function(o){"$and"!=o&&"$or"!=o&&"$nor"!=o||!Array.isArray(t[o])?"$elemmatch"==o.toLowerCase()?n[o]=t[o]:"$"==o[0]?n[o]=r(t[o]):n[e(o)]=r(t[o]):n[o]=t[o].map(function(e){return r(e)})}),n}var t=y(!0,{},this.query);this.query=r(t)},t.prototype.getExactMatches=function(){var e=this.query;if(!e||"object"!=typeof e)return{};var r={};for(var t in e)"object"!=typeof e[t]&&null!==e[t]&&void 0!==e[t]&&"$"!=t[0]&&c(r,t,e[t]);return r},t.prototype.isTrivial=function(){var e=this.query;if(!e||"object"!=typeof e)return!1;for(var r in e)if("object"==typeof e[r]||null===e[r]||void 0===e[r]||"$"==r[0])return!1;return!0},t.prototype.matchesExactFieldSet=function(e){var r=this.query;if(!r||"object"!=typeof r)return!1;for(var t={},n=0;n<e.length;n++)t[e[n]]=!0;if(Object.keys(t).length!=Object.keys(r).length)return!1;for(var o in r){if("object"==typeof r[o]||null===r[o]||void 0===r[o]||"$"==o[0])return!1;if(!t[o])return!1}return!0},t.prototype.getOperators=function(){return n(this.query)},t.isOperatorExpr=o,t.prototype.substituteVars=function(e,r){function t(n){if(!i(n))return"object"==typeof n?(Object.keys(n).forEach(function(e){n[e]=t(n[e])}),n):n;var a=n.$var;return void 0!==e[a]?e[a]:r?null:void o.push(a)}var n=this.query,o=[],a=t(n);if(o.length)throw new f(f.INVALID_QUERY,"Missing query variables: "+o.join(", "),{missingVars:o});this.query=a},t.prototype.toObject=function(){return this.query},t.prototype.combineAnd=function(e){function r(e,r){if(void 0!==r)if(void 0===a[e])a[e]=r;else if(a[e]!==r)if(Array.isArray(a.$and)&&"$and"===e&&Array.isArray(r))a.$and=a.$and.concat(r);else if("$and"===e)void 0===a.$and||Array.isArray(a.$and)||(a.$and=[a.$and]),Array.isArray(r)||(r=[r]),a.$and=a.$and.concat(r);else{a.$and&&!Array.isArray(a.$and)&&(a.$and=[a.$and]),a.$and||(a.$and=[]);var t={};t[e]=r,a.$and.push(t)}}var n,o=this.query,i=e,a={};for(n in o)r(n,o[n]);for(n in i)r(n,i[n]);return new t(a)},t.prototype.validate=function(e,r,t){function a(e){null!==e&&("object"!=typeof e||t&&i(e)?s(e):n(e).length&&h.push(new f(f.INVALID_QUERY,"Plain value object may not contain operators",{value:e})))}function u(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function s(e){return t&&i(e)?!0:u(e)}function l(e){return Array.isArray(e)?void e.forEach(function(e){u(e)}):void h.push(new f(f.INVALID_QUERY,"Value must be array: "+e))}function d(e){"boolean"!=typeof e&&h.push(new f(f.INVALID_QUERY,"Value must be boolean: "+e))}function c(e){"string"!=typeof e&&h.push(new f(f.INVALID_QUERY,"Value must be string: "+e))}function p(e,r){function t(t,n){if(!w[t])return void h.push(new f(f.INVALID_QUERY,"Invalid or disallowed operator expression: "+t));if("$gt"==t||"$gte"==t||"$lt"==t||"$lte"==t||"$ne"==t)s(n);else if("$in"==t||"$nin"==t)l(n);else if("$not"==t){if(r)return void h.push(new f(f.INVALID_QUERY,"Nested $not expressions disallowed"));p(n,!0)}else"$exists"==t?d(n):"$regex"==t||"$wildcard"==t||"$text"==t?(c(n),!!e.$regex+!!e.$wildcard+!!e.$text>1&&h.push(new f(f.INVALID_QUERY,"$regex, $wildcard, and $text cannot be used together in the same operator expression"))):"$elemMatch"==t?$(n):"$options"==t?(c(n),e.$regex||e.$wildcard||h.push(new f(f.INVALID_QUERY,"$options operator is only valid with $regex or $wildcard"))):h.push(new f(f.INVALID_QUERY,"Unknown or invalid expression operator: "+t))}return e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?void Object.keys(e).forEach(function(r){t(r,e[r])}):void h.push(new f(f.INVALID_QUERY,"Operator expression must be object"))}function y(e){o(e)?p(e):a(e)}function $(e){return e&&"object"==typeof e?void Object.keys(e).forEach(function(r){var t=e[r];if(!r)return void h.push(new f(f.INVALID_QUERY,"Field name may not be blank",{query:e}));if("$"==r[0]){if(!w[r])return void h.push(new f(f.INVALID_QUERY,"Invalid or disallowed operator: "+r));if("$and"==r||"$or"==r||"$nor"==r){if(!Array.isArray(t)||!t.length)return void h.push(new f(f.INVALID_QUERY,"Value of $and or $or must be an array with at least one element",{query:e}));t.forEach(function(e){$(e)})}else{if("$child"!=r&&"$parent"!=r)return void h.push(new f(f.INVALID_QUERY,"Operator "+r+" cannot be used as a query-level operator",{query:e}));if("object"!=typeof t||!t)return void h.push(new f(f.INVALID_QUERY,"Invalid $child/$parent operator value",{query:e}));Object.keys(t).forEach(function(e){$(t[e])})}}else y(t)}):void h.push(new f(f.INVALID_QUERY,"Query must be object",{query:e}))}var b=this.query;e||(e=["$and","$or","$nor","$exists","$in","$not","$text","$wildcard","$regex","$gt","$gte","$lt","$lte","$ne","$elemMatch","$options"]),r&&(e=e.concat(r));var w={};e.forEach(function(e){w[e]=!0});var h=[];if($(b),h.length)throw h[0];return!0},t.makeWildcardRegex=a,t.prototype.matches=function(e,r){return u(this.query,e,r)}},{extend:"extend",objtools:"objtools","regexp-quote":3,"zs-error":"zs-error"}],2:[function(e,r){function t(e){this.update=e}var n="undefined"!=typeof window?window.ZSModule.objtools:"undefined"!=typeof global?global.ZSModule.objtools:null,o=n.getPath,i=n.setPath,a=n.deletePath,u="undefined"!=typeof window?window.ZSModule.ZSError:"undefined"!=typeof global?global.ZSModule.ZSError:null,f="undefined"!=typeof window?window.extend:"undefined"!=typeof global?global.extend:null;r.exports=t,t.prototype.getUpdatedFields=function(e,r){function t(e){return u[e]?!0:"function"==typeof r.internalFields&&r.internalFields(e)?!0:!1}function o(e,r,i){var a,u,s,l;for(a in r)r.hasOwnProperty(a)&&(s=e[a],l=r[a],u=i?i+"."+a:a,"object"!=typeof s||!s||Array.isArray(s)||"object"!=typeof l||!l||Array.isArray(l)?n.scalarEquals(l,s)||(f[u]=!0):o(s,l,u));for(a in e)e.hasOwnProperty(a)&&(u=i?i+"."+a:a,void 0!==r[a]||t(u)||(f[u]=!0))}var i=this.update;if(r||(r={}),!i||"object"!=typeof i)return[];var a,u={};if(Array.isArray(r.internalFields))for(a=0;a<r.internalFields.length;a++)u[r.internalFields[a]]=!0;else"object"==typeof r.internalFields&&r.internalFields&&(u=r.internalFields);var f={};if(!this.updateHasOperators()){if(r.allowFullReplace)return o(e,i,""),Object.keys(f);i={$set:n.collapseToDotted(i,!1,!0)}}for(var s in i)if(i.hasOwnProperty(s)){var l=i[s];if(l&&"object"==typeof l)for(var d in l)l.hasOwnProperty(d)&&(f[d]=!0)}return Object.keys(f)},t.prototype.transformUpdatedFields=function(e){var r=this.update;if(r&&"object"==typeof r)if(this.hasOperators()){r=f(!0,{},r);for(var t in r)if(r.hasOwnProperty(t)){var n=r[t];if(n&&"object"==typeof n)for(var o in n)n.hasOwnProperty(o)&&(n[e(o)]=n[o])}this.update=r}else{var i={};for(var a in r)r.hasOwnProperty(a)&&(i[e(a)]=r[a]);this.update=i}},t.prototype.validate=function(e,r){var t=this.update;if(!t||"object"!=typeof t)return new u(u.INVALID_QUERY,"Update must be object");if(!this.hasOperators())return!0;e||(e=["$inc","$mul","$rename","$set","$unset","$min","$max","$currentDate","$addToSet","$pop","$push"]),r&&(e=e.concat(r));var n={};e.forEach(function(e){n[e]=!0});for(var o in t)if(t.hasOwnProperty(o)&&!n[o])return new u(u.INVALID_QUERY,"Update contains invalid, disallowed, or unknown operator: "+o);return!0},t.prototype.hasOperators=function(){var e=this.update,r=!1;for(var t in e)e.hasOwnProperty(t)&&"$"==t[0]&&(r=!0);return r},t.prototype.apply=function(e,r){function t(e){return h[e]?!0:"function"==typeof r.internalFields&&r.internalFields(e)?!0:!1}function f(n,o){t(n)||(i(e,n,o),r.modifiedCallback&&r.modifiedCallback.call(e,n,o))}function s(r){return o(e,r)}function l(n){t(n)||(a(e,n),r.modifiedCallback&&r.modifiedCallback.call(e,n,void 0))}function d(o,i,a){var u,f,s,l;for(u in i)i.hasOwnProperty(u)&&(s=o[u],l=i[u],f=a?a+"."+u:u,t(f)||("object"!=typeof s||!s||Array.isArray(s)||"object"!=typeof l||!l||Array.isArray(l)?n.scalarEquals(l,s)||(o[u]=l,r.modifiedCallback&&r.modifiedCallback.call(e,f,l)):d(s,l,f)));for(u in o)o.hasOwnProperty(u)&&(f=a?a+"."+u:u,t(f)||void 0===i[u]&&(delete o[u],r.modifiedCallback&&r.modifiedCallback.call(e,f,void 0)))}var c,p,y,$,b,w=this.update;if(r||(r={}),!w||"object"!=typeof w)return new u(u.INVALID_QUERY,"Update must be object");if(!e||"object"!=typeof e)return new u(u.INTERNAL_ERROR,"Document must be object");var h={};if(Array.isArray(r.internalFields))for($=0;$<r.internalFields.length;$++)h[r.internalFields[$]]=!0;else"object"==typeof r.internalFields&&r.internalFields&&(h=r.internalFields);if(!this.hasOperators()){if(r.allowFullReplace)return d(e,w,""),e;w={$set:n.collapseToDotted(w,!1,!0)}}for(var I in w)if(w.hasOwnProperty(I)){if("$"!=I[0])return new u(u.INVALID_QUERY,"Update cannot contain mix of operators and non-operators");var v=w[I];switch(I){case"$inc":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $inc must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],"number"!=typeof y)return new u(u.INVALID_QUERY,"$inc values must be numbers");if(null===p||void 0===p)p=v[c];else{if("number"!=typeof p)return new u(u.INVALID_QUERY,"$inc can only operate on numeric fields (field "+c+") is of type "+typeof p);p+=y}f(c,p)}break;case"$mul":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $mul must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],"number"!=typeof y)return new u(u.INVALID_QUERY,"$mul values must be numbers");if(null===p||void 0===p)p=0;else{if("number"!=typeof p)return new u(u.INVALID_QUERY,"$mul can only operate on numeric fields (field "+c+") is of type "+typeof p);p*=y}f(c,p)}break;case"$rename":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $rename must be object");var m={};for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],"string"!=typeof y||"$"==y[0])return new u(u.INVALID_QUERY,"$rename values must be valid field names");m[c]=p,l(c)}for(c in v)v.hasOwnProperty(c)&&f(v[c],m[c]);break;case"$set":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $set must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);y=v[c],f(c,y)}break;case"$unset":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $unset must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);l(c)}break;case"$min":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $min must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],"number"!=typeof y)return new u(u.INVALID_QUERY,"$min values must be numbers");if(null===p||void 0===p)f(c,y);else{if("number"!=typeof p)return new u(u.INVALID_QUERY,"$min can only operate on numeric fields (field "+c+") is of type "+typeof p);p>y&&f(c,y)}}break;case"$max":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $max must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],"number"!=typeof y)return new u(u.INVALID_QUERY,"$max values must be numbers");if(null===p||void 0===p)f(c,y);else{if("number"!=typeof p)return new u(u.INVALID_QUERY,"$max can only operate on numeric fields (field "+c+") is of type "+typeof p);y>p&&f(c,y)}}break;case"$currentDate":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $currentDate must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(y=v[c],y!==!0&&(!y||"object"!=typeof y||1!=Object.keys(y).length||"timestamp"!==y.$type&&"date"!==y.$type))return new u(u.INVALID_QUERY,"Invalid $currentDate parameter value");f(c,new Date)}break;case"$addToSet":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $addToSet must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],y&&"object"==typeof y&&y.$each){if(b=y.$each,!Array.isArray(b))return new u(u.INVALID_QUERY,"Parameter to $each must be array");if((null===p||void 0===p)&&(p=[],f(c,p)),!Array.isArray(p))return new u(u.INVALID_QUERY,"$addToSet can only operate on array fields");for($=0;$<b.length;$++){if(!n.isScalar(b[$]))return new u(u.INVALID_QUERY,"$addToSet values must be scalar");-1==p.indexOf(b[$])&&p.push(b[$])}}else{if(!n.isScalar(y))return new u(u.INVALID_QUERY,"$addToSet values must be scalar");if(null===p||void 0===p)f(c,[y]);else{if(!Array.isArray(p))return new u(u.INVALID_QUERY,"$addToSet can only operate on array fields");-1==p.indexOf(y)&&p.push(y)}}}break;case"$pop":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $pop must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],-1!==y&&1!==y)return new u(u.INVALID_QUERY,"Parameter to $pop must be 1 or -1");if(null===p||void 0===p)f(c,[]);else{if(!Array.isArray(p))return new u(u.INVALID_QUERY,"Field for $pop must be array");1===y?p.pop():p.shift()}}break;case"$push":if(!v||"object"!=typeof v)return new u(u.INVALID_QUERY,"Parameter to $push must be object");for(c in v)if(v.hasOwnProperty(c)){if("$"==c[0])return new u(u.INVALID_QUERY,"Invalid field name "+c);if(p=s(c),y=v[c],y&&"object"==typeof y&&y.$each){if(b=y.$each,!Array.isArray(b))return new u(u.INVALID_QUERY,"Parameter to $each must be array");if((null===p||void 0===p)&&(p=[],f(c,p)),!Array.isArray(p))return new u(u.INVALID_QUERY,"$push can only operate on array fields");for($=0;$<b.length;$++)p.push(b[$])}else if(null===p||void 0===p)f(c,[y]);else{if(!Array.isArray(p))return new u(u.INVALID_QUERY,"$push can only operate on array fields");p.push(y)}}break;default:return new u(u.INVALID_QUERY,"Update contains invalid/unknown operator "+I)}}return e}},{extend:"extend",objtools:"objtools","zs-error":"zs-error"}],3:[function(e,r){r.exports=function(e){return e.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")}},{}],"common-query":[function(e,r,t){var n=e("./query"),o=e("./update");t.Query=n,t.Update=o},{"./query":1,"./update":2}]},{},[])("common-query")});