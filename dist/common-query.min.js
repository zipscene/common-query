/** common-query.min.js - v0.0.14 - Mon, 22 Sep 2014 14:36:53 GMT */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;"undefined"!=typeof window?r=window:"undefined"!=typeof global?r=global:"undefined"!=typeof self&&(r=self),(r.ZS||(r.ZS={})).commonQuery=e()}}(function(){return function e(r,n,t){function o(a,u){if(!n[a]){if(!r[a]){var f="function"==typeof require&&require;if(!u&&f)return f(a,!0);if(i)return i(a,!0);var s=new Error("Cannot find module '"+a+"'");throw s.code="MODULE_NOT_FOUND",s}var l=n[a]={exports:{}};r[a][0].call(l.exports,function(e){var n=r[a][1][e];return o(n?n:e)},l,l.exports,e,r,n,t)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<t.length;a++)o(t[a]);return o}({1:[function(e,r,n){function t(e,r){function n(e){e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).forEach(function(r){if("$and"!=r&&"$or"!=r&&"$nor"!=r||!Array.isArray(e[r])){if("$"!=r[0]&&(o[r]=!0,"object"==typeof e[r]&&e[r]&&e[r].$elemMatch)){var i=t(null,e[r].$elemMatch);Array.isArray(i)&&i.forEach(function(e){o[r+"."+e]=!0})}}else e[r].forEach(function(e){n(e)})})}var o={};return n(r),Object.keys(o)}function o(e,r,n){function t(e){if(!e||"object"!=typeof e||Array.isArray(e))return e;var r={};return Object.keys(e).forEach(function(o){"$and"!=o&&"$or"!=o&&"$nor"!=o||!Array.isArray(e[o])?"$elemmatch"==o.toLowerCase()?r[o]=e[o]:"$"==o[0]?r[o]=t(e[o]):r[n(o)]=t(e[o]):r[o]=e[o].map(function(e){return t(e)})}),r}return r=w(!0,{},r),t(r)}function i(e){if(!e||"object"!=typeof e)return{};var r={};for(var n in e)"object"!=typeof e[n]&&null!==e[n]&&void 0!==e[n]&&"$"!=n[0]&&v(r,n,e[n]);return r}function a(e){if(!e||"object"!=typeof e)return!1;for(var r in e)if("object"==typeof e[r]||null===e[r]||void 0===e[r]||"$"==r[0])return!1;return!0}function u(e,r){if(!e||"object"!=typeof e)return!1;for(var n={},t=0;t<r.length;t++)n[r[t]]=!0;if(Object.keys(n).length!=Object.keys(e).length)return!1;for(var o in e){if("object"==typeof e[o]||null===e[o]||void 0===e[o]||"$"==o[0])return!1;if(!n[o])return!1}return!0}function f(e,r){function n(e){e&&"object"==typeof e&&Object.keys(e).forEach(function(r){"$"==r[0]&&(t[r]=!0),n(e[r])})}var t={};return n(r),Object.keys(t)}function s(e){return"object"==typeof e&&!Array.isArray(e)&&e&&Object.keys(e).length&&Object.keys(e).every(function(e){return"$"==e[0]})?!0:!1}function l(e){return e&&"object"==typeof e?1!=Object.keys(e).length?!1:e.$var&&"string"==typeof e.$var?!0:!1:!1}function c(e,r,n){function t(e){if(!l(e))return"object"==typeof e?(Object.keys(e).forEach(function(r){e[r]=t(e[r])}),e):e;var i=e.$var;return void 0!==r[i]?r[i]:n?null:void o.push(i)}var o=[],i=t(e);return o.length?new $($.INVALID_QUERY,"Missing query variables: "+o.join(", "),{missingVars:o}):i}function d(e,r,n,t,o){function i(e){null!==e&&("object"!=typeof e||o&&l(e)?u(e):f(null,e).length&&v.push(new $($.INVALID_QUERY,"Plain value object may not contain operators",{value:e})))}function a(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function u(e){return o&&l(e)?!0:a(e)}function c(e){return Array.isArray(e)?void e.forEach(function(e){a(e)}):void v.push(new $($.INVALID_QUERY,"Value must be array: "+e))}function d(e){"boolean"!=typeof e&&v.push(new $($.INVALID_QUERY,"Value must be boolean: "+e))}function p(e){"string"!=typeof e&&v.push(new $($.INVALID_QUERY,"Value must be string: "+e))}function y(e,r){function n(n,t){if(!m[n])return void v.push(new $($.INVALID_QUERY,"Invalid or disallowed operator expression: "+n));if("$gt"==n||"$gte"==n||"$lt"==n||"$lte"==n||"$ne"==n)u(t);else if("$in"==n||"$nin"==n)c(t);else if("$not"==n){if(r)return void v.push(new $($.INVALID_QUERY,"Nested $not expressions disallowed"));y(t,!0)}else"$exists"==n?d(t):"$regex"==n||"$wildcard"==n||"$text"==n?(p(t),!!e.$regex+!!e.$wildcard+!!e.$text>1&&v.push(new $($.INVALID_QUERY,"$regex, $wildcard, and $text cannot be used together in the same operator expression"))):"$elemMatch"==n?I(t):"$options"==n?(p(t),e.$regex||e.$wildcard||v.push(new $($.INVALID_QUERY,"$options operator is only valid with $regex or $wildcard"))):v.push(new $($.INVALID_QUERY,"Unknown or invalid expression operator: "+n))}return e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?void Object.keys(e).forEach(function(r){n(r,e[r])}):void v.push(new $($.INVALID_QUERY,"Operator expression must be object"))}function b(e){s(e)?y(e):i(e)}function I(e){return e&&"object"==typeof e?void Object.keys(e).forEach(function(r){var n=e[r];if(!r)return void v.push(new $($.INVALID_QUERY,"Field name may not be blank",{query:e}));if("$"==r[0]){if(!m[r])return void v.push(new $($.INVALID_QUERY,"Invalid or disallowed operator: "+r));if("$and"==r||"$or"==r||"$nor"==r){if(!Array.isArray(n)||!n.length)return void v.push(new $($.INVALID_QUERY,"Value of $and or $or must be an array with at least one element",{query:e}));n.forEach(function(e){I(e)})}else{if("$child"!=r&&"$parent"!=r)return void v.push(new $($.INVALID_QUERY,"Operator "+r+" cannot be used as a query-level operator",{query:e}));if("object"!=typeof n||!n)return void v.push(new $($.INVALID_QUERY,"Invalid $child/$parent operator value",{query:e}));Object.keys(n).forEach(function(e){I(n[e])})}}else b(n)}):void v.push(new $($.INVALID_QUERY,"Query must be object",{query:e}))}n||(n=["$and","$or","$nor","$exists","$in","$not","$text","$wildcard","$regex","$gt","$gte","$lt","$lte","$ne","$elemMatch","$options"]),t&&(n=n.concat(t));var m={};n.forEach(function(e){m[e]=!0});var v=[];return I(r),v.length?v[0]:!0}function p(e){for(var r,n="^",t=0;t<e.length;t++)r=e[t],n+="*"==r?".*":"?"==r?".?":b(r);return n+"$"}function y(e,r,n,t){function o(e,r,n,o,i){return"$in"==n?Array.isArray(o)?o.some(function(e){return A(e,r)}):(l.push(new $($.INTERNAL_ERROR,"Invalid query after validation - expected array for $in")),!1):"$text"==n?(t.textMatches||E)(r,o):"$wildcard"==n?new RegExp(p(o),i.$options).test(r):"$regex"==n?new RegExp(o,i.$options).test(r):"$gt"==n?r>o:"$gte"==n?r>=o:"$lt"==n?o>r:"$lte"==n?o>=r:"$ne"==n?!A(r,o):"$options"==n?!0:(l.push(new $($.INTERNAL_ERROR,"Unknown operator expr operator after validation: "+n)),!1)}function i(e,r,n,t,a){return"$exists"==n?t?void 0!==r:void 0===r:"$not"==n?!Object.keys(t).every(function(n){return i(e,r,n,t[n],t)}):"$elemMatch"==n?Array.isArray(r)?r.some(function(e){var r=y(null,t,e,!0);return r instanceof $?(l.push(r),!1):r}):!1:Array.isArray(r)?r.some(function(r){return o(e,r,n,t,a)}):o(e,r,n,t,a)}function a(e,r){var t=m(n,e);return s(r)?Object.keys(r).every(function(n){return i(e,t,n,r[n],r)}):void 0===t?!1:Array.isArray(t)?t.some(function(e){return A(e,r)}):A(t,r)}function u(e){return Object.keys(e).every(function(r){var n=e[r];return"$"==r[0]?"$and"==r?n.every(u):"$or"==r?n.some(u):"$nor"==r?!n.some(u):(l.push(new $($.INTERNAL_ERROR,"Query processing failed after validation - got unknown query level operator: "+r)),!1):a(r,n)})}if(t||(t={}),!t.skipValidate){var f=d(e,r);if(f!==!0)return f}var l=[],c=u(r);return l.length?l[0]:!!c}var $=e("zs-error"),b=e("regexp-quote"),I=e("objtools"),m=I.getPath,v=I.setPath,A=I.deepEquals,w=e("extend"),E=function(e,r){return new RegExp(r.replace(" ",".+")).test(e)};n.getQueriedFields=t,n.transformQueriedFields=o,n.queryToObject=i,n.isBasicQuery=a,n.queryMatchesExactFieldSet=u,n.getOperators=f,n.isOperatorExpr=s,n.substituteVars=c,n.validateQuery=d,n.makeWildcardRegex=p,n.queryMatches=y},{extend:"extend",objtools:"objtools","regexp-quote":3,"zs-error":"zs-error"}],2:[function(e,r,n){function t(e,r,n,t){function o(e){return s[e]?!0:"function"==typeof t.internalFields&&t.internalFields(e)?!0:!1}function i(e,r,n){var t,a,u,s;for(t in r)u=e[t],s=r[t],a=n?n+"."+t:t,"object"!=typeof u||!u||Array.isArray(u)||"object"!=typeof s||!s||Array.isArray(s)?f.scalarEquals(s,u)||(l[a]=!0):i(u,s,a);for(t in e)a=n?n+"."+t:t,void 0!==r[t]||o(a)||(l[a]=!0)}if(t||(t={}),!n||"object"!=typeof n)return[];var u,s={};if(Array.isArray(t.internalFields))for(u=0;u<t.internalFields.length;u++)s[t.internalFields[u]]=!0;else"object"==typeof t.internalFields&&t.internalFields&&(s=t.internalFields);var l={};if(!a(n)){if(t.allowFullReplace)return i(r,n,""),Object.keys(l);n={$set:n}}for(var c in n){var d=n[c];if(d&&"object"==typeof d)for(var p in d)l[p]=!0}return Object.keys(l)}function o(e,r,n){if(!r||"object"!=typeof r)return r;if(a(r)){r=p(!0,{},r);for(var t in r){var o=r[t];if(o&&"object"==typeof o)for(var i in o)o[n(i)]=o[i]}return r}var u={};for(var f in r)u[n(f)]=r[f];return u}function i(e,r,n,t){if(!r||"object"!=typeof r)return new d(d.INVALID_QUERY,"Update must be object");if(!a(r))return!0;n||(n=["$inc","$mul","$rename","$set","$unset","$min","$max","$currentDate","$addToSet","$pop","$push"]),t&&(n=n.concat(t));var o={};n.forEach(function(e){o[e]=!0});for(var i in r)if(!o[i])return new d(d.INVALID_QUERY,"Update contains invalid, disallowed, or unknown operator: "+i);return!0}function a(e){var r=!1;for(var n in e)"$"==n[0]&&(r=!0);return r}function u(e,r,n,t){function o(e){return A[e]?!0:"function"==typeof t.internalFields&&t.internalFields(e)?!0:!1}function i(e,n){o(e)||(l(r,e,n),t.modifiedCallback&&t.modifiedCallback.call(r,e,n))}function u(e){return s(r,e)}function p(e){o(e)||(c(r,e),t.modifiedCallback&&t.modifiedCallback.call(r,e,void 0))}function y(e,n,i){var a,u,s,l;for(a in n)s=e[a],l=n[a],u=i?i+"."+a:a,o(u)||("object"!=typeof s||!s||Array.isArray(s)||"object"!=typeof l||!l||Array.isArray(l)?f.scalarEquals(l,s)||(e[a]=l,t.modifiedCallback&&t.modifiedCallback.call(r,u,l)):y(s,l,u));for(a in e)u=i?i+"."+a:a,o(u)||void 0===n[a]&&(delete e[a],t.modifiedCallback&&t.modifiedCallback.call(r,u,void 0))}var $,b,I,m,v;if(t||(t={}),!n||"object"!=typeof n)return new d(d.INVALID_QUERY,"Update must be object");if(!r||"object"!=typeof r)return new d(d.INTERNAL_ERROR,"Document must be object");var A={};if(Array.isArray(t.internalFields))for(m=0;m<t.internalFields.length;m++)A[t.internalFields[m]]=!0;else"object"==typeof t.internalFields&&t.internalFields&&(A=t.internalFields);if(!a(n)){if(t.allowFullReplace)return y(r,n,""),r;n={$set:n}}for(var w in n){if("$"!=w[0])return new d(d.INVALID_QUERY,"Update cannot contain mix of operators and non-operators");var E=n[w];switch(w){case"$inc":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $inc must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$inc values must be numbers");if(null===b||void 0===b)b=E[$];else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$inc can only operate on numeric fields (field "+$+") is of type "+typeof b);b+=I}i($,b)}break;case"$mul":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $mul must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$mul values must be numbers");if(null===b||void 0===b)b=0;else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$mul can only operate on numeric fields (field "+$+") is of type "+typeof b);b*=I}i($,b)}break;case"$rename":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $rename must be object");var j={};for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],"string"!=typeof I||"$"==I[0])return new d(d.INVALID_QUERY,"$rename values must be valid field names");j[$]=b,p($)}for($ in E)i(E[$],j[$]);break;case"$set":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $set must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);I=E[$],i($,I)}break;case"$unset":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $unset must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);p($)}break;case"$min":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $min must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$min values must be numbers");if(null===b||void 0===b)i($,I);else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$min can only operate on numeric fields (field "+$+") is of type "+typeof b);b>I&&i($,I)}}break;case"$max":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $max must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$max values must be numbers");if(null===b||void 0===b)i($,I);else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$max can only operate on numeric fields (field "+$+") is of type "+typeof b);I>b&&i($,I)}}break;case"$currentDate":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $currentDate must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(I=E[$],I!==!0&&(!I||"object"!=typeof I||1!=Object.keys(I).length||"timestamp"!==I.$type&&"date"!==I.$type))return new d(d.INVALID_QUERY,"Invalid $currentDate parameter value");i($,new Date)}break;case"$addToSet":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $addToSet must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],I&&"object"==typeof I&&I.$each){if(v=I.$each,!Array.isArray(v))return new d(d.INVALID_QUERY,"Parameter to $each must be array");if((null===b||void 0===b)&&(b=[],i($,b)),!Array.isArray(b))return new d(d.INVALID_QUERY,"$addToSet can only operate on array fields");for(m=0;m<v.length;m++){if(!f.isScalar(v[m]))return new d(d.INVALID_QUERY,"$addToSet values must be scalar");-1==b.indexOf(v[m])&&b.push(v[m])}}else{if(!f.isScalar(I))return new d(d.INVALID_QUERY,"$addToSet values must be scalar");if(null===b||void 0===b)i($,[I]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"$addToSet can only operate on array fields");-1==b.indexOf(I)&&b.push(I)}}}break;case"$pop":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $pop must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],-1!==I&&1!==I)return new d(d.INVALID_QUERY,"Parameter to $pop must be 1 or -1");if(null===b||void 0===b)i($,[]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"Field for $pop must be array");1===I?b.pop():b.shift()}}break;case"$push":if(!E||"object"!=typeof E)return new d(d.INVALID_QUERY,"Parameter to $push must be object");for($ in E){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=u($),I=E[$],I&&"object"==typeof I&&I.$each){if(v=I.$each,!Array.isArray(v))return new d(d.INVALID_QUERY,"Parameter to $each must be array");if((null===b||void 0===b)&&(b=[],i($,b)),!Array.isArray(b))return new d(d.INVALID_QUERY,"$push can only operate on array fields");for(m=0;m<v.length;m++)b.push(v[m])}else if(null===b||void 0===b)i($,[I]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"$push can only operate on array fields");b.push(I)}}break;default:return new d(d.INVALID_QUERY,"Update contains invalid/unknown operator "+w)}}return r}var f=e("objtools"),s=f.getPath,l=f.setPath,c=f.deletePath,d=e("zs-error"),p=e("extend");n.getUpdatedFields=t,n.transformUpdatedFields=o,n.validateUpdate=i,n.updateHasOperators=a,n.applyUpdate=u},{extend:"extend",objtools:"objtools","zs-error":"zs-error"}],3:[function(e,r){r.exports=function(e){return e.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")}},{}],"common-query":[function(e,r,n){var t,o=e("./query"),i=e("./update");for(t in o)n[t]=o[t];for(t in i)n[t]=i[t]},{"./query":1,"./update":2}]},{},[])("common-query")});