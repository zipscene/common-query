/** common-query.min.js - v0.0.21 - Mon, 22 Sep 2014 14:54:46 GMT */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;"undefined"!=typeof window?r=window:"undefined"!=typeof global?r=global:"undefined"!=typeof self&&(r=self),(r.ZS||(r.ZS={})).commonQuery=e()}}(function(){return function e(r,n,t){function o(i,f){if(!n[i]){if(!r[i]){var u="function"==typeof require&&require;if(!f&&u)return u(i,!0);if(a)return a(i,!0);var s=new Error("Cannot find module '"+i+"'");throw s.code="MODULE_NOT_FOUND",s}var l=n[i]={exports:{}};r[i][0].call(l.exports,function(e){var n=r[i][1][e];return o(n?n:e)},l,l.exports,e,r,n,t)}return n[i].exports}for(var a="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(e,r,n){function t(e,r){function n(e){e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).forEach(function(r){if("$and"!=r&&"$or"!=r&&"$nor"!=r||!Array.isArray(e[r])){if("$"!=r[0]&&(o[r]=!0,"object"==typeof e[r]&&e[r]&&e[r].$elemMatch)){var a=t(null,e[r].$elemMatch);Array.isArray(a)&&a.forEach(function(e){o[r+"."+e]=!0})}}else e[r].forEach(function(e){n(e)})})}var o={};return n(r),Object.keys(o)}function o(e,r,n){function t(e){if(!e||"object"!=typeof e||Array.isArray(e))return e;var r={};return Object.keys(e).forEach(function(o){"$and"!=o&&"$or"!=o&&"$nor"!=o||!Array.isArray(e[o])?"$elemmatch"==o.toLowerCase()?r[o]=e[o]:"$"==o[0]?r[o]=t(e[o]):r[n(o)]=t(e[o]):r[o]=e[o].map(function(e){return t(e)})}),r}return r=h(!0,{},r),t(r)}function a(e){if(!e||"object"!=typeof e)return{};var r={};for(var n in e)"object"!=typeof e[n]&&null!==e[n]&&void 0!==e[n]&&"$"!=n[0]&&A(r,n,e[n]);return r}function i(e){if(!e||"object"!=typeof e)return!1;for(var r in e)if("object"==typeof e[r]||null===e[r]||void 0===e[r]||"$"==r[0])return!1;return!0}function f(e,r){if(!e||"object"!=typeof e)return!1;for(var n={},t=0;t<r.length;t++)n[r[t]]=!0;if(Object.keys(n).length!=Object.keys(e).length)return!1;for(var o in e){if("object"==typeof e[o]||null===e[o]||void 0===e[o]||"$"==o[0])return!1;if(!n[o])return!1}return!0}function u(e,r){function n(e){e&&"object"==typeof e&&Object.keys(e).forEach(function(r){"$"==r[0]&&(t[r]=!0),n(e[r])})}var t={};return n(r),Object.keys(t)}function s(e){return"object"==typeof e&&!Array.isArray(e)&&e&&Object.keys(e).length&&Object.keys(e).every(function(e){return"$"==e[0]})?!0:!1}function l(e){return e&&"object"==typeof e?1!=Object.keys(e).length?!1:e.$var&&"string"==typeof e.$var?!0:!1:!1}function c(e,r,n){function t(e){if(!l(e))return"object"==typeof e?(Object.keys(e).forEach(function(r){e[r]=t(e[r])}),e):e;var a=e.$var;return void 0!==r[a]?r[a]:n?null:void o.push(a)}var o=[],a=t(e);return o.length?new b(b.INVALID_QUERY,"Missing query variables: "+o.join(", "),{missingVars:o}):a}function d(e,r){function n(e,r){if(void 0!==r)if(void 0===o[e])o[e]=r;else if(o[e]!==r)if(Array.isArray(o.$and)&&"$and"===e&&Array.isArray(r))o.$and=o.$and.concat(r);else if("$and"===e)void 0===o.$and||Array.isArray(o.$and)||(o.$and=[o.$and]),Array.isArray(r)||(r=[r]),o.$and=o.$and.concat(r);else{o.$and&&!Array.isArray(o.$and)&&(o.$and=[o.$and]),o.$and||(o.$and=[]);var n={};n[e]=r,o.$and.push(n)}}var t,o={};for(t in e)n(t,e[t]);for(t in r)n(t,r[t]);return o}function y(e,r,n,t,o){function a(e){null!==e&&("object"!=typeof e||o&&l(e)?f(e):u(null,e).length&&v.push(new b(b.INVALID_QUERY,"Plain value object may not contain operators",{value:e})))}function i(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function f(e){return o&&l(e)?!0:i(e)}function c(e){return Array.isArray(e)?void e.forEach(function(e){i(e)}):void v.push(new b(b.INVALID_QUERY,"Value must be array: "+e))}function d(e){"boolean"!=typeof e&&v.push(new b(b.INVALID_QUERY,"Value must be boolean: "+e))}function y(e){"string"!=typeof e&&v.push(new b(b.INVALID_QUERY,"Value must be string: "+e))}function p(e,r){function n(n,t){if(!m[n])return void v.push(new b(b.INVALID_QUERY,"Invalid or disallowed operator expression: "+n));if("$gt"==n||"$gte"==n||"$lt"==n||"$lte"==n||"$ne"==n)f(t);else if("$in"==n||"$nin"==n)c(t);else if("$not"==n){if(r)return void v.push(new b(b.INVALID_QUERY,"Nested $not expressions disallowed"));p(t,!0)}else"$exists"==n?d(t):"$regex"==n||"$wildcard"==n||"$text"==n?(y(t),!!e.$regex+!!e.$wildcard+!!e.$text>1&&v.push(new b(b.INVALID_QUERY,"$regex, $wildcard, and $text cannot be used together in the same operator expression"))):"$elemMatch"==n?I(t):"$options"==n?(y(t),e.$regex||e.$wildcard||v.push(new b(b.INVALID_QUERY,"$options operator is only valid with $regex or $wildcard"))):v.push(new b(b.INVALID_QUERY,"Unknown or invalid expression operator: "+n))}return e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).length?void Object.keys(e).forEach(function(r){n(r,e[r])}):void v.push(new b(b.INVALID_QUERY,"Operator expression must be object"))}function $(e){s(e)?p(e):a(e)}function I(e){return e&&"object"==typeof e?void Object.keys(e).forEach(function(r){var n=e[r];if(!r)return void v.push(new b(b.INVALID_QUERY,"Field name may not be blank",{query:e}));if("$"==r[0]){if(!m[r])return void v.push(new b(b.INVALID_QUERY,"Invalid or disallowed operator: "+r));if("$and"==r||"$or"==r||"$nor"==r){if(!Array.isArray(n)||!n.length)return void v.push(new b(b.INVALID_QUERY,"Value of $and or $or must be an array with at least one element",{query:e}));n.forEach(function(e){I(e)})}else{if("$child"!=r&&"$parent"!=r)return void v.push(new b(b.INVALID_QUERY,"Operator "+r+" cannot be used as a query-level operator",{query:e}));if("object"!=typeof n||!n)return void v.push(new b(b.INVALID_QUERY,"Invalid $child/$parent operator value",{query:e}));Object.keys(n).forEach(function(e){I(n[e])})}}else $(n)}):void v.push(new b(b.INVALID_QUERY,"Query must be object",{query:e}))}n||(n=["$and","$or","$nor","$exists","$in","$not","$text","$wildcard","$regex","$gt","$gte","$lt","$lte","$ne","$elemMatch","$options"]),t&&(n=n.concat(t));var m={};n.forEach(function(e){m[e]=!0});var v=[];return I(r),v.length?v[0]:!0}function p(e){for(var r,n="^",t=0;t<e.length;t++)r=e[t],n+="*"==r?".*":"?"==r?".?":I(r);return n+"$"}function $(e,r,n,t){function o(e,r,n,o,a){return"$in"==n?Array.isArray(o)?o.some(function(e){return w(e,r)}):(l.push(new b(b.INTERNAL_ERROR,"Invalid query after validation - expected array for $in")),!1):"$text"==n?(t.textMatches||E)(r,o):"$wildcard"==n?new RegExp(p(o),a.$options).test(r):"$regex"==n?new RegExp(o,a.$options).test(r):"$gt"==n?r>o:"$gte"==n?r>=o:"$lt"==n?o>r:"$lte"==n?o>=r:"$ne"==n?!w(r,o):"$options"==n?!0:(l.push(new b(b.INTERNAL_ERROR,"Unknown operator expr operator after validation: "+n)),!1)}function a(e,r,n,t,i){return"$exists"==n?t?void 0!==r:void 0===r:"$not"==n?!Object.keys(t).every(function(n){return a(e,r,n,t[n],t)}):"$elemMatch"==n?Array.isArray(r)?r.some(function(e){var r=$(null,t,e,!0);return r instanceof b?(l.push(r),!1):r}):!1:Array.isArray(r)?r.some(function(r){return o(e,r,n,t,i)}):o(e,r,n,t,i)}function i(e,r){var t=v(n,e);return s(r)?Object.keys(r).every(function(n){return a(e,t,n,r[n],r)}):void 0===t?!1:Array.isArray(t)?t.some(function(e){return w(e,r)}):w(t,r)}function f(e){return Object.keys(e).every(function(r){var n=e[r];return"$"==r[0]?"$and"==r?n.every(f):"$or"==r?n.some(f):"$nor"==r?!n.some(f):(l.push(new b(b.INTERNAL_ERROR,"Query processing failed after validation - got unknown query level operator: "+r)),!1):i(r,n)})}if(t||(t={}),!t.skipValidate){var u=y(e,r);if(u!==!0)return u}var l=[],c=f(r);return l.length?l[0]:!!c}var b=e("zs-error"),I=e("regexp-quote"),m=e("objtools"),v=m.getPath,A=m.setPath,w=m.deepEquals,h=e("extend"),E=function(e,r){return new RegExp(r.replace(" ",".+")).test(e)};n.getQueriedFields=t,n.transformQueriedFields=o,n.queryToObject=a,n.isBasicQuery=i,n.queryMatchesExactFieldSet=f,n.getOperators=u,n.isOperatorExpr=s,n.substituteVars=c,n.combineQueriesAnd=d,n.validateQuery=y,n.makeWildcardRegex=p,n.queryMatches=$},{extend:"extend",objtools:"objtools","regexp-quote":3,"zs-error":"zs-error"}],2:[function(e,r,n){function t(e,r,n,t){function o(e){return s[e]?!0:"function"==typeof t.internalFields&&t.internalFields(e)?!0:!1}function a(e,r,n){var t,i,f,s;for(t in r)r.hasOwnProperty(t)&&(f=e[t],s=r[t],i=n?n+"."+t:t,"object"!=typeof f||!f||Array.isArray(f)||"object"!=typeof s||!s||Array.isArray(s)?u.scalarEquals(s,f)||(l[i]=!0):a(f,s,i));for(t in e)e.hasOwnProperty(t)&&(i=n?n+"."+t:t,void 0!==r[t]||o(i)||(l[i]=!0))}if(t||(t={}),!n||"object"!=typeof n)return[];var f,s={};if(Array.isArray(t.internalFields))for(f=0;f<t.internalFields.length;f++)s[t.internalFields[f]]=!0;else"object"==typeof t.internalFields&&t.internalFields&&(s=t.internalFields);var l={};if(!i(n)){if(t.allowFullReplace)return a(r,n,""),Object.keys(l);n={$set:n}}for(var c in n)if(n.hasOwnProperty(c)){var d=n[c];if(d&&"object"==typeof d)for(var y in d)d.hasOwnProperty(y)&&(l[y]=!0)}return Object.keys(l)}function o(e,r,n){if(!r||"object"!=typeof r)return r;if(i(r)){r=y(!0,{},r);for(var t in r)if(r.hasOwnProperty(t)){var o=r[t];if(o&&"object"==typeof o)for(var a in o)o.hasOwnProperty(a)&&(o[n(a)]=o[a])}return r}var f={};for(var u in r)r.hasOwnProperty(u)&&(f[n(u)]=r[u]);return f}function a(e,r,n,t){if(!r||"object"!=typeof r)return new d(d.INVALID_QUERY,"Update must be object");if(!i(r))return!0;n||(n=["$inc","$mul","$rename","$set","$unset","$min","$max","$currentDate","$addToSet","$pop","$push"]),t&&(n=n.concat(t));var o={};n.forEach(function(e){o[e]=!0});for(var a in r)if(r.hasOwnProperty(a)&&!o[a])return new d(d.INVALID_QUERY,"Update contains invalid, disallowed, or unknown operator: "+a);return!0}function i(e){var r=!1;for(var n in e)e.hasOwnProperty(n)&&"$"==n[0]&&(r=!0);return r}function f(e,r,n,t){function o(e){return A[e]?!0:"function"==typeof t.internalFields&&t.internalFields(e)?!0:!1}function a(e,n){o(e)||(l(r,e,n),t.modifiedCallback&&t.modifiedCallback.call(r,e,n))}function f(e){return s(r,e)}function y(e){o(e)||(c(r,e),t.modifiedCallback&&t.modifiedCallback.call(r,e,void 0))}function p(e,n,a){var i,f,s,l;for(i in n)n.hasOwnProperty(i)&&(s=e[i],l=n[i],f=a?a+"."+i:i,o(f)||("object"!=typeof s||!s||Array.isArray(s)||"object"!=typeof l||!l||Array.isArray(l)?u.scalarEquals(l,s)||(e[i]=l,t.modifiedCallback&&t.modifiedCallback.call(r,f,l)):p(s,l,f)));for(i in e)e.hasOwnProperty(i)&&(f=a?a+"."+i:i,o(f)||void 0===n[i]&&(delete e[i],t.modifiedCallback&&t.modifiedCallback.call(r,f,void 0)))}var $,b,I,m,v;if(t||(t={}),!n||"object"!=typeof n)return new d(d.INVALID_QUERY,"Update must be object");if(!r||"object"!=typeof r)return new d(d.INTERNAL_ERROR,"Document must be object");var A={};if(Array.isArray(t.internalFields))for(m=0;m<t.internalFields.length;m++)A[t.internalFields[m]]=!0;else"object"==typeof t.internalFields&&t.internalFields&&(A=t.internalFields);if(!i(n)){if(t.allowFullReplace)return p(r,n,""),r;n={$set:n}}for(var w in n)if(n.hasOwnProperty(w)){if("$"!=w[0])return new d(d.INVALID_QUERY,"Update cannot contain mix of operators and non-operators");var h=n[w];switch(w){case"$inc":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $inc must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$inc values must be numbers");if(null===b||void 0===b)b=h[$];else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$inc can only operate on numeric fields (field "+$+") is of type "+typeof b);b+=I}a($,b)}break;case"$mul":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $mul must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$mul values must be numbers");if(null===b||void 0===b)b=0;else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$mul can only operate on numeric fields (field "+$+") is of type "+typeof b);b*=I}a($,b)}break;case"$rename":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $rename must be object");var E={};for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],"string"!=typeof I||"$"==I[0])return new d(d.INVALID_QUERY,"$rename values must be valid field names");E[$]=b,y($)}for($ in h)h.hasOwnProperty($)&&a(h[$],E[$]);break;case"$set":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $set must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);I=h[$],a($,I)}break;case"$unset":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $unset must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);y($)}break;case"$min":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $min must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$min values must be numbers");if(null===b||void 0===b)a($,I);else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$min can only operate on numeric fields (field "+$+") is of type "+typeof b);b>I&&a($,I)}}break;case"$max":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $max must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],"number"!=typeof I)return new d(d.INVALID_QUERY,"$max values must be numbers");if(null===b||void 0===b)a($,I);else{if("number"!=typeof b)return new d(d.INVALID_QUERY,"$max can only operate on numeric fields (field "+$+") is of type "+typeof b);I>b&&a($,I)}}break;case"$currentDate":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $currentDate must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(I=h[$],I!==!0&&(!I||"object"!=typeof I||1!=Object.keys(I).length||"timestamp"!==I.$type&&"date"!==I.$type))return new d(d.INVALID_QUERY,"Invalid $currentDate parameter value");a($,new Date)}break;case"$addToSet":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $addToSet must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],I&&"object"==typeof I&&I.$each){if(v=I.$each,!Array.isArray(v))return new d(d.INVALID_QUERY,"Parameter to $each must be array");if((null===b||void 0===b)&&(b=[],a($,b)),!Array.isArray(b))return new d(d.INVALID_QUERY,"$addToSet can only operate on array fields");for(m=0;m<v.length;m++){if(!u.isScalar(v[m]))return new d(d.INVALID_QUERY,"$addToSet values must be scalar");-1==b.indexOf(v[m])&&b.push(v[m])}}else{if(!u.isScalar(I))return new d(d.INVALID_QUERY,"$addToSet values must be scalar");if(null===b||void 0===b)a($,[I]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"$addToSet can only operate on array fields");-1==b.indexOf(I)&&b.push(I)}}}break;case"$pop":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $pop must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],-1!==I&&1!==I)return new d(d.INVALID_QUERY,"Parameter to $pop must be 1 or -1");if(null===b||void 0===b)a($,[]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"Field for $pop must be array");1===I?b.pop():b.shift()}}break;case"$push":if(!h||"object"!=typeof h)return new d(d.INVALID_QUERY,"Parameter to $push must be object");for($ in h)if(h.hasOwnProperty($)){if("$"==$[0])return new d(d.INVALID_QUERY,"Invalid field name "+$);if(b=f($),I=h[$],I&&"object"==typeof I&&I.$each){if(v=I.$each,!Array.isArray(v))return new d(d.INVALID_QUERY,"Parameter to $each must be array");if((null===b||void 0===b)&&(b=[],a($,b)),!Array.isArray(b))return new d(d.INVALID_QUERY,"$push can only operate on array fields");for(m=0;m<v.length;m++)b.push(v[m])}else if(null===b||void 0===b)a($,[I]);else{if(!Array.isArray(b))return new d(d.INVALID_QUERY,"$push can only operate on array fields");b.push(I)}}break;default:return new d(d.INVALID_QUERY,"Update contains invalid/unknown operator "+w)}}return r}var u=e("objtools"),s=u.getPath,l=u.setPath,c=u.deletePath,d=e("zs-error"),y=e("extend");n.getUpdatedFields=t,n.transformUpdatedFields=o,n.validateUpdate=a,n.updateHasOperators=i,n.applyUpdate=f},{extend:"extend",objtools:"objtools","zs-error":"zs-error"}],3:[function(e,r){r.exports=function(e){return e.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")}},{}],"common-query":[function(e,r,n){var t,o=e("./query"),a=e("./update");for(t in o)n[t]=o[t];for(t in a)n[t]=a[t]},{"./query":1,"./update":2}]},{},[])("common-query")});